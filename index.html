<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>La Vie Noire — Admin CMS</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0b0b; --panel:#111111; --accent-red:#ff1a1a; --gold:#FFD700;
  --white:#fff; --muted:#bdbdbd; --neon:#00ffff; --btn-green:#013220;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#050505);font-family:Montserrat,system-ui,Arial,sans-serif;color:var(--white)}
header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px}
.brand{display:flex;align-items:center;gap:14px}
.logo-wrap{width:84px;height:84px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:pointer}
.logo-wrap img{width:100%;height:100%;object-fit:cover}
.nav{display:flex;gap:12px;align-items:center}
.btn{background:var(--btn-green);color:var(--white);border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700}
.ghost{background:transparent;border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:8px}
.hero{display:grid;grid-template-columns:1fr 420px;gap:32px;align-items:center;padding:32px 4%;min-height:40vh}
h2{font-family:'Playfair Display',serif;color:var(--accent-red)}
.lead{color:var(--muted)}
.card{background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,.6)}
.content{padding:18px 4%;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}
.card-item{background:var(--panel);border-radius:12px;padding:12px;position:relative;overflow:hidden}
.thumb{height:160px;border-radius:8px;background:#000;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
.thumb img{width:100%;height:100%;object-fit:cover}
.tag{position:absolute;top:12px;left:12px;background:rgba(0,0,0,.6);padding:6px 8px;border-radius:6px;color:var(--gold);font-weight:700}
.locked{position:absolute;right:12px;top:12px;background:rgba(0,0,0,.6);padding:6px 8px;border-radius:6px;color:var(--accent-red);font-weight:700}
.admin-bar{position:fixed;right:12px;bottom:12px;display:flex;gap:8px;z-index:999}
.admin-small{background:var(--neon);color:#000;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:999}
.modal.open{display:flex}
.modal-body{background:#0d0d0d;padding:20px;border-radius:12px;width:480px;max-width:96%}
.field{margin-bottom:10px}
input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:var(--white)}
.admin-btn{background:var(--gold);color:#000;border:none;padding:6px 8px;border-radius:6px;cursor:pointer;font-weight:700;margin-left:6px}
@media(max-width:880px){ .hero{grid-template-columns:1fr} }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo-wrap" id="logoWrap"><img id="heroLogo" src="LA2.png" alt="logo"></div>
    <div><h2 style="margin:0">La Vie Noire</h2><div style="color:var(--muted)">Members Only</div></div>
  </div>
  <div class="nav">
    <button class="btn" id="adminLoginBtn">Admin Login</button>
  </div>
</header>

<section class="hero">
  <div>
    <h2>La Vie <span style="color:var(--gold)">Noire</span></h2>
    <p class="lead">Admin panel — manage cards, media and hero logo.</p>
    <div style="margin-top:12px"><button class="btn" id="addCardHeaderBtn" style="display:none">Add New Card</button></div>
  </div>
  <aside class="card">
    <div style="text-align:center"><img id="centerLogo" src="LA2.png" alt="center logo" style="max-width:240px;cursor:pointer"></div>
    <div style="margin-top:12px;color:var(--muted)">Click logo to update (admin only)</div>
  </aside>
</section>

<section class="content" id="creators"></section>

<footer style="padding:24px 4%;color:var(--muted);text-align:center">© 2025 La Vie Noire</footer>

<!-- Hidden file input -->
<input type="file" id="fileInput" style="display:none" />

<!-- Admin Login Modal -->
<div class="modal" id="adminModal">
  <div class="modal-body">
    <h3>Admin Login</h3>
    <div class="field"><input id="adminEmail" placeholder="Email"></div>
    <div class="field"><input id="adminPass" type="password" placeholder="Password"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="ghost" onclick="closeAdminModal()">Cancel</button>
      <button class="btn" onclick="doAdminLogin()">Login</button>
    </div>
    <div id="adminMsg" style="color:var(--muted);margin-top:8px"></div>
  </div>
</div>

<!-- Add / Edit Card Modal (reused) -->
<div class="modal" id="cardModal">
  <div class="modal-body">
    <h3 id="cardModalTitle">Add Card</h3>
    <div class="field"><input id="cardTitle" placeholder="Title"></div>
    <div class="field"><input id="cardTag" placeholder="Tag (e.g. Premium)"></div>
    <div class="field"><textarea id="cardDesc" placeholder="Description"></textarea></div>
    <div class="field"><input type="file" id="cardMediaInput"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="ghost" onclick="closeCardModal()">Cancel</button>
      <button class="btn" id="cardSaveBtn" onclick="saveCard()">Save</button>
    </div>
    <div id="cardModalMsg" style="color:var(--muted);margin-top:8px"></div>
  </div>
</div>

<script>
/* ===== CONFIG - update if needed ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbxJt_B9vTktCZ0hPArSQWifBqeSJA2fXMK4FPo6CPJzPNvH8t0dagsNZPAo5oyvXmvvAQ/exec';
const ADMIN_EMAIL = 'pieterpoesie7@gmail.com';
const ADMIN_PASSWORD = 'Poessie';

/* ===== State ===== */
let isAdmin = false;
let cards = [];
let editingCardId = null; // null for add

/* ===== Helpers ===== */
function openAdminModal(){ document.getElementById('adminModal').classList.add('open'); }
function closeAdminModal(){ document.getElementById('adminModal').classList.remove('open'); }
function openCardModal(mode='add'){ 
  document.getElementById('cardModalTitle').textContent = mode==='add' ? 'Add New Card' : 'Edit Card';
  document.getElementById('cardModal').classList.add('open'); 
}
function closeCardModal(){ document.getElementById('cardModal').classList.remove('open'); document.getElementById('cardModalMsg').textContent=''; }

/* ===== Admin Login ===== */
document.getElementById('adminLoginBtn').addEventListener('click', openAdminModal);
function doAdminLogin(){
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  const msg = document.getElementById('adminMsg');
  if(!email || !pass){ msg.textContent = 'Enter email & password'; return; }
  // Local check then enable admin mode (Apps Script also has adminLogin if needed)
  if(email === ADMIN_EMAIL && pass === ADMIN_PASSWORD){
    isAdmin = true;
    msg.textContent = '';
    closeAdminModal();
    document.getElementById('addCardHeaderBtn').style.display = 'inline-block';
    refreshCards();
  } else {
    msg.textContent = 'Invalid credentials';
  }
}

/* ===== Fetch & Render ===== */
async function refreshCards(){
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    cards = data.cards || [];
    renderCards();
  } catch (err) {
    console.error('fetch cards error', err);
    document.getElementById('creators').innerHTML = '<div style="color:tomato;padding:20px">Failed to load cards — check API_URL and Apps Script deployment.</div>';
  }
}

function renderCards(){
  const container = document.getElementById('creators');
  container.innerHTML = '';
  if(!cards.length){
    container.innerHTML = '<div style="color:var(--muted);padding:24px">No cards yet. Admin can add new cards.</div>';
    return;
  }
  cards.forEach((c, i) => {
    const art = document.createElement('article');
    art.className = 'card-item';
    art.innerHTML = `
      <div class="tag">${escapeHtml(c.tag || '')}</div>
      <div class="locked">Locked</div>
      <div class="thumb" id="thumb-${i}">
        ${c.mediaURL ? `<img src="${escapeAttr(c.mediaURL)}" alt="media">` : '<div style="color:var(--muted)">No media</div>'}
      </div>
      <h3>${escapeHtml(c.title || '')}</h3>
      <p class="muted">${escapeHtml(c.description || '')}</p>
    `;
    if(isAdmin){
      // admin buttons
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.className = 'admin-btn';
      editBtn.onclick = ()=> openEditCard(c);
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.className = 'admin-btn';
      delBtn.onclick = ()=> deleteCard(c.id);
      art.querySelector('.thumb').appendChild(editBtn);
      art.querySelector('.thumb').appendChild(delBtn);
    }
    container.appendChild(art);
  });
}

/* ===== Escape helpers ===== */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }
function escapeAttr(s){ return escapeHtml(s); }

/* ===== Add / Edit Card ===== */
document.getElementById('addCardHeaderBtn').addEventListener('click', ()=>{ editingCardId = null; clearCardModal(); openCardModal('add'); });

function clearCardModal(){
  document.getElementById('cardTitle').value='';
  document.getElementById('cardTag').value='';
  document.getElementById('cardDesc').value='';
  document.getElementById('cardMediaInput').value='';
  document.getElementById('cardModalMsg').textContent='';
  editingCardId = null;
}

function openEditCard(card){
  editingCardId = card.id;
  document.getElementById('cardTitle').value = card.title || '';
  document.getElementById('cardTag').value = card.tag || '';
  document.getElementById('cardDesc').value = card.description || '';
  document.getElementById('cardMediaInput').value = '';
  openCardModal('edit');
}

async function saveCard(){
  const title = document.getElementById('cardTitle').value.trim();
  const tag = document.getElementById('cardTag').value.trim();
  const desc = document.getElementById('cardDesc').value.trim();
  const fileInput = document.getElementById('cardMediaInput');
  const msg = document.getElementById('cardModalMsg');

  if(!title || !tag || !desc){ msg.textContent = 'Title, tag and description are required'; return; }
  msg.textContent = 'Saving...';

  try {
    let payload = { action: editingCardId ? 'edit' : 'add', title, tag, description: desc };
    if(editingCardId) payload.id = editingCardId;

    // if file selected, read as base64 and send
    if(fileInput.files && fileInput.files[0]){
      const file = fileInput.files[0];
      const base64 = await readFileAsDataURL(file);
      payload.base64 = base64;
      payload.name = file.name;
      payload.mime = file.type;
    }

    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if(result.ok){
      msg.textContent = 'Saved';
      closeCardModal();
      await refreshCards();
    } else {
      msg.textContent = 'Save failed: ' + (result.error || result.message || 'unknown');
      console.error('saveCard error', result);
    }
  } catch (err) {
    msg.textContent = 'Save error: ' + err.toString();
    console.error(err);
  }
}

/* ===== Delete ===== */
async function deleteCard(id){
  if(!confirm('Delete this card?')) return;
  try {
    const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'delete', id }) });
    const j = await res.json();
    if(j.ok){ await refreshCards(); } else { alert('Delete failed: ' + (j.error||j.message)); }
  } catch (err){ alert('Delete error: '+err); console.error(err); }
}

/* ===== Hero/logo upload ===== */
document.getElementById('logoWrap').addEventListener('click', async ()=>{
  if(!isAdmin) { alert('Admin only'); return; }
  const file = await pickFile();
  if(!file) return;
  try {
    const base64 = await readFileAsDataURL(file);
    const payload = { action: 'setHeroLogo', base64, name: file.name, mime: file.type };
    const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await res.json();
    if(j.ok && j.url){
      document.getElementById('heroLogo').src = j.url;
      document.getElementById('centerLogo').src = j.url;
      alert('Hero logo updated');
    } else {
      alert('Upload failed: ' + (j.error||j.message));
    }
  } catch (err){ alert('Upload error: '+err); console.error(err); }
});

/* ===== Utility: read file as dataURL ===== */
function readFileAsDataURL(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
function pickFile(){
  return new Promise(resolve=>{
    const input = document.getElementById('fileInput');
    input.onchange = ()=> resolve(input.files[0] || null);
    input.click();
  });
}

/* ===== Init ===== */
refreshCards();
</script>
</body>
</html>
